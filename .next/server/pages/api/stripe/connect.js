"use strict";(()=>{var e={};e.id=899,e.ids=[899],e.modules={4001:e=>{e.exports=require("@supabase/auth-helpers-nextjs")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6090:e=>{e.exports=import("stripe")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})},1388:(e,t,r)=>{r.a(e,async(e,o)=>{try{r.r(t),r.d(t,{config:()=>l,default:()=>u,routeModule:()=>d});var n=r(1802),a=r(7153),i=r(6249),s=r(7595),c=e([s]);s=(c.then?(await c)():c)[0];let u=(0,i.l)(s,"default"),l=(0,i.l)(s,"config"),d=new n.PagesAPIRouteModule({definition:{kind:a.x.PAGES_API,page:"/api/stripe/connect",pathname:"/api/stripe/connect",bundlePath:"",filename:""},userland:s});o()}catch(e){o(e)}})},7595:(e,t,r)=>{r.a(e,async(e,o)=>{try{r.r(t),r.d(t,{default:()=>s});var n=r(4001),a=r(6090),i=e([a]);let c=new(a=(i.then?(await i)():i)[0]).default(process.env.STRIPE_SECRET_KEY||"");async function s(e,t){if("POST"!==e.method)return t.status(405).json({error:"Method not allowed"});try{let r=(0,n.createServerSupabaseClient)({req:e,res:t}),{data:{session:o}}=await r.auth.getSession();if(!o)return console.error("No session found"),t.status(401).json({error:"Not authenticated"});let a=o.user;console.log("Authenticated user:",a.id,a.email);let{userId:i}=e.body;if(i&&i!==a.id)return t.status(403).json({error:"User ID mismatch"});let{data:s,error:u}=await r.from("profiles").select("stripe_account_id").eq("id",a.id).single();if(u&&"PGRST116"!==u.code)throw console.error("Error fetching profile:",u),Error(u.message);let l=s?.stripe_account_id;if(console.log("Existing Stripe account ID:",l),!l){console.log("Creating new Stripe account for:",a.email),l=(await c.accounts.create({type:"express",email:a.email})).id,console.log("Created Stripe account:",l);let{error:e}=await r.from("profiles").update({stripe_account_id:l}).eq("id",a.id);if(e)throw console.error("Error updating profile:",e),Error(e.message)}let d=process.env.NEXT_PUBLIC_BASE_URL||"http://localhost:3000";console.log("Creating account link with base URL:",d);let p=await c.accountLinks.create({account:l,refresh_url:`${d}/host/connect-stripe`,return_url:`${d}/host/dashboard`,type:"account_onboarding"});return console.log("Created account link, returning URL"),t.status(200).json({url:p.url})}catch(e){return console.error("Error in Stripe connect:",e),t.status(500).json({error:e.message||"Internal server error",stack:void 0})}}o()}catch(e){o(e)}})},7153:(e,t)=>{var r;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return r}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(r||(r={}))},1802:(e,t,r)=>{e.exports=r(145)}};var t=require("../../../webpack-api-runtime.js");t.C(e);var r=t(t.s=1388);module.exports=r})();