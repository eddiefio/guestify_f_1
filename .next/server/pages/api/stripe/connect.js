"use strict";(()=>{var e={};e.id=899,e.ids=[899],e.modules={2885:e=>{e.exports=require("@supabase/supabase-js")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6090:e=>{e.exports=import("stripe")},6249:(e,r)=>{Object.defineProperty(r,"l",{enumerable:!0,get:function(){return function e(r,t){return t in r?r[t]:"then"in r&&"function"==typeof r.then?r.then(r=>e(r,t)):"function"==typeof r&&"default"===t?r:void 0}}})},1388:(e,r,t)=>{t.a(e,async(e,o)=>{try{t.r(r),t.d(r,{config:()=>l,default:()=>c,routeModule:()=>d});var n=t(1802),s=t(7153),i=t(6249),a=t(7595),u=e([a]);a=(u.then?(await u)():u)[0];let c=(0,i.l)(a,"default"),l=(0,i.l)(a,"config"),d=new n.PagesAPIRouteModule({definition:{kind:s.x.PAGES_API,page:"/api/stripe/connect",pathname:"/api/stripe/connect",bundlePath:"",filename:""},userland:a});o()}catch(e){o(e)}})},7595:(e,r,t)=>{t.a(e,async(e,o)=>{try{t.r(r),t.d(r,{default:()=>a});var n=t(2885),s=t(6090),i=e([s]);s=(i.then?(await i)():i)[0];let u=process.env.NEXT_PUBLIC_SUPABASE_URL||"https://ndiqnzxplopcbcxzondp.supabase.co",c=process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY||"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5kaXFuenhwbG9wY2JjeHpvbmRwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzk1NDkxODQsImV4cCI6MjA1NTEyNTE4NH0.jCnn7TFfGV1EpBHhO1ITa8PMytD7UJfADpuzrzZOgpw",l=process.env.STRIPE_SECRET_KEY,d=(e,r)=>{if(!e)return null;let t=e.match(RegExp("(^| )"+r+"=([^;]+)"));return t?t[2]:null};async function a(e,r){if("POST"!==e.method)return r.status(405).json({error:"Method not allowed"});console.log("Processing Stripe connect request");try{let t,o;let i=e.headers.cookie;console.log("Request cookies:",i?"Present":"None");let a=d(i,"supabase-access-token");if(console.log("Token from cookie:",a?"Present":"None"),e.body.userEmail&&(o=e.body.userEmail,console.log("Using email from request body:",o)),a)try{let e=(0,n.createClient)(u,c),{data:s,error:i}=await e.auth.getUser(a);if(i)return console.error("Error getting user from token:",i),r.status(401).json({error:"Invalid token"});t=s.user,!o&&t.email&&(o=t.email)}catch(e){return console.error("Exception getting user from token:",e),r.status(401).json({error:"Authentication error"})}else{if(!e.body.userId)return console.error("No user information available"),r.status(401).json({error:"User ID is required"});t={id:e.body.userId},console.log("Using user ID from request body:",t.id)}if(!t||!t.id)return r.status(400).json({error:"User ID not found"});if(!o)return r.status(400).json({error:"User email is required. Please include it in the request."});if(!l)return r.status(500).json({error:"Stripe secret key not configured"});let p=new s.default(l),f=await p.accounts.create({type:"express",email:o,capabilities:{card_payments:{requested:!0},transfers:{requested:!0}}});console.log("Created Stripe account:",f.id);let P=(0,n.createClient)(u,c),{error:m}=await P.from("profiles").update({stripe_account_id:f.id}).eq("id",t.id);m&&console.error("Error updating user profile with Stripe ID:",m);let I=process.env.NEXT_PUBLIC_BASE_URL||e.headers.origin||"http://localhost:3000",h=await p.accountLinks.create({account:f.id,refresh_url:`${I}/host/stripe-redirect?error=true&account_id=${f.id}`,return_url:`${I}/host/stripe-redirect?success=true&account_id=${f.id}`,type:"account_onboarding"});return console.log("Created Stripe account link"),r.status(200).json({url:h.url})}catch(e){return console.error("Error in Stripe connect handler:",e),r.status(500).json({error:e.message||"Internal server error"})}}o()}catch(e){o(e)}})},7153:(e,r)=>{var t;Object.defineProperty(r,"x",{enumerable:!0,get:function(){return t}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(t||(t={}))},1802:(e,r,t)=>{e.exports=t(145)}};var r=require("../../../webpack-api-runtime.js");r.C(e);var t=r(r.s=1388);module.exports=t})();